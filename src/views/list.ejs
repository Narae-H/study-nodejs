<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Node.js</title>

  <link href="/main.css" rel="stylesheet">
  <link href="/list.css" rel="stylesheet">
</head>

<body class="grey-bg">
  <%- include('nav.ejs') %>

  <form action="/posts/search" method="GET">
    <input class="saerch" type="text" name="searchTerm">
    <button class="search-send" type="submit">ê²€ìƒ‰</button>
  </form>

  <div class="white-bg">
    <% for(let i=0; i<ê¸€ëª©ë¡.length; i++) { %>
      <div class="list-box">
        <h4>
          <a href="/posts/<%= ê¸€ëª©ë¡[i]._id %>"><%= ê¸€ëª©ë¡[i].title %></a>
          <a href="/posts/<%= ê¸€ëª©ë¡[i]._id %>/edit">âœï¸</a>
          <% if( user != null && (ê¸€ëª©ë¡[i].user?.toString ==  user?._id.toString) ) { %>
            <span class="delete" data-id="<%= ê¸€ëª©ë¡[i]._id %>" style="cursor: pointer;">ğŸ—‘ï¸</span>
          <% } %>
        </h4>
        <p><%= ê¸€ëª©ë¡[i].content %></p>
      </div>
    <% } %> 
  </div>

  <div class="white-bg align-right">
    <a href="/posts?page=1" class="nav-btn">1</a>
    <a href="/posts?page=2" class="nav-btn">2</a>
    <a href="/posts?page=3" class="nav-btn">3</a>
    <a href="/posts?page=4" class="nav-btn">4</a>
    <a href="/posts?page=5" class="nav-btn">5</a>
  </div>

<script>
  document.querySelectorAll(".delete").forEach( (item)=>{
    item.addEventListener("click", function(e) {
      fetch("/posts", {
        method : 'DELETE',
        headers : { 'Content-Type' : 'application/json' },
        body : JSON.stringify({_id : e.target.dataset.id})
      })
      .then( (r) => r.text() )
      .then( (r) => { 
        const rJSON = JSON.parse(r);
        
        if( rJSON.deletedCount > 0 ){
          // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ê·¸ëƒ¥ ì•ˆë³´ì´ê²Œë§Œ í•˜ê¸° (ì–´ì°¨í”¼ ë°ì´í„°ëŠ” ì‚­ì œë˜ì—ˆìŒ)
          e.target.parentElement.parentElement.style.display = 'none';
        }
      }) 
    })
  })

</script>

</body>
</html>